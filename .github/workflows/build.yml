name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc-13
            cxx: g++-13
          - compiler: clang
            cc: clang-18
            cxx: clang++-18

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            libwebkit2gtk-4.1-dev \
            ${{ matrix.compiler == 'gcc' && 'g++-13' || 'clang-18' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm install
        working-directory: ui

      - name: Configure CMake (Dev Mode)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDEV_MODE=ON \
            -DENABLE_SANITIZERS=ON
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: Build (Dev Mode)
        run: cmake --build build --parallel

      - name: Configure CMake (Production Mode)
        run: |
          rm -rf build
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DDEV_MODE=OFF \
            -DENABLE_SANITIZERS=ON
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: Build (Production Mode)
        run: cmake --build build --parallel

      - name: Verify executable exists
        run: |
          test -f build/bin/app
          ./build/bin/app --version
          ./build/bin/app --help

  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install ninja

      - name: Install LLVM (Homebrew)
        run: |
          brew update
          brew install llvm@20
          LLVM_PREFIX="$(brew --prefix llvm@20)"
          echo "LLVM_PREFIX=$LLVM_PREFIX" >> "$GITHUB_ENV"
          echo "CLANG_BIN_DIR=$LLVM_PREFIX/bin" >> "$GITHUB_ENV"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm install
        working-directory: ui

      - name: Configure CMake (LLVM Homebrew)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DDEV_MODE=OFF \
            -DENABLE_SANITIZERS=ON \
            -DCMAKE_TOOLCHAIN_FILE=cmake/clang_toolchain.cmake \
            -DCLANG_BIN_DIR="$CLANG_BIN_DIR"

      - name: Build
        run: cmake --build build --parallel

      - name: Verify executable exists
        run: |
          test -f build/bin/app
          ./build/bin/app --version

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ninja
        run: choco install ninja -y

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm install
        working-directory: ui

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DDEV_MODE=OFF `
            -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Verify executable exists
        run: |
          Test-Path build/bin/app.exe
          ./build/bin/app.exe --version
