name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc-13
            cxx: g++-13
          - compiler: clang
            cc: clang-18
            cxx: clang++-18

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ninja-build \
            libwebkit2gtk-4.1-dev \
            ${{ matrix.compiler == 'gcc' && 'g++-13' || 'clang-18' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm install
        working-directory: ui

      - name: Configure CMake (Dev Mode)
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_BUILD_TYPE=Debug \
            -DDEV_MODE=ON \
            -DENABLE_SANITIZERS=ON
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: Build (Dev Mode)
        run: cmake --build build --parallel

      - name: Configure CMake (Production Mode)
        run: |
          rm -rf build
          cmake -B build -G Ninja \
            -DCMAKE_C_COMPILER=${{ matrix.cc }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DDEV_MODE=OFF \
            -DENABLE_SANITIZERS=ON
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}

      - name: Build (Production Mode)
        run: cmake --build build --parallel

      - name: Verify executable exists
        run: |
          test -f build/bin/app
          ./build/bin/app --version
          ./build/bin/app --help

  build-macos:
    runs-on: macos-latest
    env:
      # Common Homebrew LLVM prefix on GitHub macOS runners (ARM). This is a
      # reasonable default so CMake sees compilers even before any install step.
      CC: /opt/homebrew/opt/llvm/bin/clang
      CXX: /opt/homebrew/opt/llvm/bin/clang++
      AR: /opt/homebrew/opt/llvm/bin/llvm-ar
      RANLIB: /opt/homebrew/opt/llvm/bin/llvm-ranlib
      CPPFLAGS: -I/opt/homebrew/opt/llvm/include
      CXXFLAGS: -std=c++20 -fexperimental-library
      LDFLAGS: -L/opt/homebrew/opt/llvm/lib -L/opt/homebrew/opt/llvm/lib/c++ -L/opt/homebrew/opt/llvm/lib/unwind -Wl,-rpath,/opt/homebrew/opt/llvm/lib/c++ -lunwind

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ninja
        run: brew install ninja

      - name: Install LLVM via Homebrew
        run: |
          brew update
          brew install llvm
          LLVM_PREFIX="$(brew --prefix llvm)"
          echo "LLVM_PREFIX=$LLVM_PREFIX" >> "$GITHUB_ENV"
          # Put LLVM clang in front of PATH
          echo "$LLVM_PREFIX/bin" >> "$GITHUB_PATH"
          {
            echo "CC=$LLVM_PREFIX/bin/clang"
            echo "CXX=$LLVM_PREFIX/bin/clang++"
            echo "AR=$LLVM_PREFIX/bin/llvm-ar"
            echo "RANLIB=$LLVM_PREFIX/bin/llvm-ranlib"
            echo "CPPFLAGS=-I$LLVM_PREFIX/include"
            echo "CXXFLAGS=-std=c++20 -fexperimental-library"
            # Do not add -lc++ explicitly to LDFLAGS to avoid duplicate -lc++ warnings;
            # provide library/search paths and libunwind. clang++ will still link libc++.
            echo "LDFLAGS=-L$LLVM_PREFIX/lib -L$LLVM_PREFIX/lib/c++ -L$LLVM_PREFIX/lib/unwind -Wl,-rpath,$LLVM_PREFIX/lib/c++ -lunwind" \
              >> "$GITHUB_ENV"
          }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm install
        working-directory: ui

      - name: Show clang version
        run: |
          which clang++
          clang++ --version
          $CC --version
          $CXX --version

      - name: Clean build directory
        run: rm -rf build || true

      - name: Configure (CMake)
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DDEV_MODE=OFF \
            -DENABLE_SANITIZERS=ON \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_AR="$AR" \
            -DCMAKE_RANLIB="$RANLIB" \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" \
            -DCMAKE_SHARED_LINKER_FLAGS="$LDFLAGS"

      - name: Build
        run: cmake --build build --parallel

      - name: Verify executable exists
        run: |
          test -f build/bin/app
          ./build/bin/app --version

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ninja
        run: choco install ninja -y

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install UI dependencies
        run: npm install
        working-directory: ui

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DDEV_MODE=OFF `
            -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Verify executable exists
        run: |
          Test-Path build/bin/app.exe
          ./build/bin/app.exe --version
